<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas - Firebase</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #444;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 30px;
            background: #667eea;
            border-radius: 5px;
        }
        
        .cadastro h2::before { background: #4CAF50; }
        .vendas h2::before { background: #2196F3; }
        .dashboard h2::before { background: #FF9800; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-top: 5px solid #667eea;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .lista {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item:last-child {
            border-bottom: none;
        }
        
        .item-codigo {
            font-weight: bold;
            color: #667eea;
        }
        
        .item-nome {
            flex-grow: 1;
            margin: 0 15px;
        }
        
        .item-preco {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .sections {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè™ Sistema de Vendas Firebase</h1>
            <p class="subtitle">Cadastro de produtos, registro de vendas e dashboard em tempo real</p>
        </header>
        
        <div class="sections">
            <!-- SE√á√ÉO 1: CADASTRO DE PRODUTOS -->
            <div class="section cadastro">
                <h2>‚ûï Cadastrar Produto</h2>
                <div class="form-group">
                    <label for="codigo">C√≥digo do Produto:</label>
                    <input type="text" id="codigo" placeholder="Ex: PROD001" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label for="nome">Nome do Produto:</label>
                    <input type="text" id="nome" placeholder="Ex: Camiseta B√°sica">
                </div>
                
                <div class="form-group">
                    <label for="preco">Pre√ßo (R$):</label>
                    <input type="number" id="preco" placeholder="Ex: 29.90" step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label for="estoque">Quantidade em Estoque:</label>
                    <input type="number" id="estoque" placeholder="Ex: 100" min="0">
                </div>
                
                <div class="form-group">
                    <label for="categoria">Categoria:</label>
                    <select id="categoria">
                        <option value="Roupas">Roupas</option>
                        <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                
                <button onclick="cadastrarProduto()">üì¶ Salvar Produto no Banco</button>
                <div id="status-cadastro" class="status"></div>
                
                <h3 style="margin-top: 30px;">üìã Produtos Cadastrados</h3>
                <div class="lista" id="lista-produtos">
                    <div class="loading">Carregando produtos...</div>
                </div>
            </div>
            
            <!-- SE√á√ÉO 2: REGISTRO DE VENDAS -->
            <div class="section vendas">
                <h2>üí∞ Registrar Venda</h2>
                
                <div class="form-group">
                    <label for="produtoVenda">Selecione o Produto:</label>
                    <select id="produtoVenda">
                        <option value="">Carregando produtos...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quantidade">Quantidade Vendida:</label>
                    <input type="number" id="quantidade" placeholder="Ex: 2" min="1" value="1">
                </div>
                
                <div class="form-group">
                    <label for="cliente">Nome do Cliente:</label>
                    <input type="text" id="cliente" placeholder="Ex: Jo√£o Silva">
                </div>
                
                <div class="form-group">
                    <label for="formaPagamento">Forma de Pagamento:</label>
                    <select id="formaPagamento">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                        <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                        <option value="PIX">PIX</option>
                    </select>
                </div>
                
                <button onclick="registrarVenda()">üí≥ Registrar Venda no Banco</button>
                <div id="status-venda" class="status"></div>
                
                <h3 style="margin-top: 30px;">üõí √öltimas Vendas</h3>
                <div class="lista" id="lista-vendas">
                    <div class="loading">Carregando vendas...</div>
                </div>
            </div>
            
            <!-- SE√á√ÉO 3: DASHBOARD -->
            <div class="section dashboard">
                <h2>üìä Dashboard em Tempo Real</h2>
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total de Produtos</div>
                        <div class="stat-value" id="total-produtos">0</div>
                        <div class="stat-label">cadastrados</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Total de Vendas</div>
                        <div class="stat-value" id="total-vendas">0</div>
                        <div class="stat-label">realizadas</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Faturamento Total</div>
                        <div class="stat-value" id="faturamento">R$ 0</div>
                        <div class="stat-label">acumulado</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Venda Hoje</div>
                        <div class="stat-value" id="vendas-hoje">0</div>
                        <div class="stat-label">unidades</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>üìà Produtos Mais Vendidos</h3>
                    <div id="top-produtos" class="lista">
                        <div class="loading">Analisando dados...</div>
                    </div>
                </div>
                
                <div class="filters">
                    <button onclick="filtrarHoje()" style="background: #4CAF50;">Hoje</button>
                    <button onclick="filtrarSemana()" style="background: #2196F3;">Esta Semana</button>
                    <button onclick="filtrarMes()" style="background: #FF9800;">Este M√™s</button>
                    <button onclick="filtrarTodos()" style="background: #9C27B0;">Todos</button>
                </div>
            </div>
        </div>
        
        <footer style="text-align: center; margin-top: 40px; color: #666; padding-top: 20px; border-top: 1px solid #eee;">
            <p>üî• Sistema conectado ao Firebase | üìä Dados em tempo real | üöÄ Hospedado no GitHub/Vercel</p>
        </footer>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        // SUAS CONFIGURA√á√ïES DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDhxzoRmrYhuIwKkFtlF_H36NklLwVXSN0",
            authDomain: "deliveryapp-a6c48.firebaseapp.com",
            databaseURL: "https://deliveryapp-a6c48-default-rtdb.firebaseio.com",
            projectId: "deliveryapp-a6c48",
            storageBucket: "deliveryapp-a6c48.firebasestorage.app",
            messagingSenderId: "547092721941",
            appId: "1:547092721941:web:b0feaefe7d6265c32bf91c"
        };

        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot,
            query,
            orderBy,
            where,
            serverTimestamp,
            updateDoc,
            doc,
            increment
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Vari√°veis globais
        let produtos = [];
        let filtroAtual = 'todos';

        // ========== FUN√á√ÉO: CADASTRAR PRODUTO ==========
        window.cadastrarProduto = async function() {
            const codigo = document.getElementById('codigo').value.trim();
            const nome = document.getElementById('nome').value.trim();
            const preco = parseFloat(document.getElementById('preco').value);
            const estoque = parseInt(document.getElementById('estoque').value);
            const categoria = document.getElementById('categoria').value;
            
            // Valida√ß√£o
            if (!codigo || !nome || !preco || !estoque) {
                showStatus('status-cadastro', 'Por favor, preencha todos os campos!', 'error');
                return;
            }
            
            // Verificar se c√≥digo j√° existe
            if (produtos.some(p => p.codigo === codigo)) {
                showStatus('status-cadastro', 'C√≥digo j√° existe! Use outro c√≥digo.', 'error');
                return;
            }
            
            try {
                const produto = {
                    codigo,
                    nome,
                    preco,
                    estoque,
                    categoria,
                    dataCadastro: new Date().toISOString(),
                    vendas: 0,
                    estoqueAtual: estoque
                };
                
                // SALVA NO FIREBASE (cole√ß√£o "produtos")
                await addDoc(collection(db, "produtos"), produto);
                
                showStatus('status-cadastro', '‚úÖ Produto cadastrado com sucesso!', 'success');
                
                // Limpar formul√°rio
                document.getElementById('codigo').value = '';
                document.getElementById('nome').value = '';
                document.getElementById('preco').value = '';
                document.getElementById('estoque').value = '';
                
            } catch (error) {
                showStatus('status-cadastro', '‚ùå Erro ao cadastrar: ' + error.message, 'error');
            }
        };

        // ========== FUN√á√ÉO: REGISTRAR VENDA ==========
        window.registrarVenda = async function() {
            const produtoSelect = document.getElementById('produtoVenda');
            const produtoId = produtoSelect.value;
            const quantidade = parseInt(document.getElementById('quantidade').value);
            const cliente = document.getElementById('cliente').value.trim();
            const formaPagamento = document.getElementById('formaPagamento').value;
            
            if (!produtoId || !cliente || !quantidade) {
                showStatus('status-venda', 'Preencha todos os campos!', 'error');
                return;
            }
            
            const produto = produtos.find(p => p.id === produtoId);
            if (!produto) {
                showStatus('status-venda', 'Produto n√£o encontrado!', 'error');
                return;
            }
            
            if (quantidade > produto.estoqueAtual) {
                showStatus('status-venda', `Estoque insuficiente! Dispon√≠vel: ${produto.estoqueAtual}`, 'error');
                return;
            }
            
            try {
                // Registrar venda
                const venda = {
                    produtoId,
                    produtoCodigo: produto.codigo,
                    produtoNome: produto.nome,
                    quantidade,
                    valorUnitario: produto.preco,
                    valorTotal: produto.preco * quantidade,
                    cliente,
                    formaPagamento,
                    dataVenda: serverTimestamp(),
                    dataVendaLocal: new Date().toISOString()
                };
                
                // SALVA NO FIREBASE (cole√ß√£o "vendas")
                await addDoc(collection(db, "vendas"), venda);
                
                // Atualizar estoque do produto
                const produtoRef = doc(db, "produtos", produtoId);
                await updateDoc(produtoRef, {
                    estoqueAtual: increment(-quantidade),
                    vendas: increment(quantidade)
                });
                
                showStatus('status-venda', '‚úÖ Venda registrada com sucesso!', 'success');
                document.getElementById('cliente').value = '';
                document.getElementById('quantidade').value = '1';
                
            } catch (error) {
                showStatus('status-venda', '‚ùå Erro ao registrar venda: ' + error.message, 'error');
            }
        };

        // ========== FUN√á√ïES DO DASHBOARD ==========
        window.filtrarHoje = () => filtroAtual = 'hoje';
        window.filtrarSemana = () => filtroAtual = 'semana';
        window.filtrarMes = () => filtroAtual = 'mes';
        window.filtrarTodos = () => filtroAtual = 'todos';

        // ========== FUN√á√ïES AUXILIARES ==========
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            setTimeout(() => element.textContent = '', 3000);
        }

        function formatCurrency(value) {
            return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR').substring(0, 5);
        }

        // ========== CARREGAR DADOS EM TEMPO REAL ==========
        // Escutar produtos
        onSnapshot(collection(db, "produtos"), (snapshot) => {
            produtos = [];
            const listaProdutos = document.getElementById('lista-produtos');
            const selectProdutos = document.getElementById('produtoVenda');
            
            listaProdutos.innerHTML = '';
            selectProdutos.innerHTML = '<option value="">Selecione um produto</option>';
            
            snapshot.forEach((doc) => {
                const produto = { id: doc.id, ...doc.data() };
                produtos.push(produto);
                
                // Adicionar √† lista visual
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <span class="item-codigo">${produto.codigo}</span>
                    <span class="item-nome">${produto.nome}</span>
                    <span class="item-preco">${formatCurrency(produto.preco)}</span>
                    <span style="color: ${produto.estoqueAtual < 10 ? 'red' : 'green'}">
                        Estoque: ${produto.estoqueAtual}
                    </span>
                `;
                listaProdutos.appendChild(item);
                
                // Adicionar ao select de vendas (se tiver estoque)
                if (produto.estoqueAtual > 0) {
                    const option = document.createElement('option');
                    option.value = produto.id;
                    option.textContent = `${produto.codigo} - ${produto.nome} (Estoque: ${produto.estoqueAtual})`;
                    selectProdutos.appendChild(option);
                }
            });
            
            // Atualizar dashboard
            document.getElementById('total-produtos').textContent = produtos.length;
            
            if (snapshot.empty) {
                listaProdutos.innerHTML = '<div class="loading">Nenhum produto cadastrado ainda.</div>';
            }
        });

        // Escutar vendas e atualizar dashboard
        onSnapshot(collection(db, "vendas"), (snapshot) => {
            const listaVendas = document.getElementById('lista-vendas');
            const hoje = new Date().toLocaleDateString('pt-BR');
            let totalVendas = 0;
            let faturamento = 0;
            let vendasHoje = 0;
            const vendasPorProduto = {};
            
            listaVendas.innerHTML = '';
            
            snapshot.forEach((doc) => {
                const venda = { id: doc.id, ...doc.data() };
                totalVendas++;
                faturamento += venda.valorTotal || 0;
                
                // Verificar se venda √© de hoje
                if (venda.dataVendaLocal && venda.dataVendaLocal.includes(new Date().toISOString().split('T')[0])) {
                    vendasHoje += venda.quantidade || 1;
                }
                
                // Contar por produto
                if (venda.produtoCodigo) {
                    vendasPorProduto[venda.produtoCodigo] = 
                        (vendasPorProduto[venda.produtoCodigo] || 0) + (venda.quantidade || 1);
                }
                
                // Adicionar √† lista (apenas √∫ltimas 5)
                if (totalVendas <= 5) {
                    const item = document.createElement('div');
                    item.className = 'item';
                    item.innerHTML = `
                        <div>
                            <strong>${venda.produtoNome || 'Produto'}</strong><br>
                            <small>${venda.cliente || 'Cliente'} - ${formatDate(venda.dataVendaLocal || new Date())}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${venda.quantidade}x</strong><br>
                            <span style="color: #4CAF50">${formatCurrency(venda.valorTotal || 0)}</span>
                        </div>
                    `;
                    listaVendas.appendChild(item);
                }
            });
            
            // Atualizar dashboard
            document.getElementById('total-vendas').textContent = totalVendas;
            document.getElementById('faturamento').textContent = formatCurrency(faturamento);
            document.getElementById('vendas-hoje').textContent = vendasHoje;
            
            // Top produtos
            const topProdutosDiv = document.getElementById('top-produtos');
            const top5 = Object.entries(vendasPorProduto)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            topProdutosDiv.innerHTML = '';
            top5.forEach(([codigo, qtd], index) => {
                const produto = produtos.find(p => p.codigo === codigo);
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <span style="font-weight: bold; color: #667eea;">${index + 1}¬∫</span>
                    <span style="flex-grow: 1; margin: 0 10px;">${produto?.nome || codigo}</span>
                    <span style="color: #4CAF50; font-weight: bold;">${qtd} vendas</span>
                `;
                topProdutosDiv.appendChild(item);
            });
            
            if (top5.length === 0) {
                topProdutosDiv.innerHTML = '<div class="loading">Nenhuma venda registrada ainda.</div>';
            }
            
            if (snapshot.empty) {
                listaVendas.innerHTML = '<div class="loading">Nenhuma venda registrada ainda.</div>';
            }
        });

        // Mostrar que o sistema est√° carregado
        setTimeout(() => {
            showStatus('status-cadastro', '‚úÖ Sistema conectado ao Firebase!', 'success');
        }, 1000);
    </script>
</body>
</html>
