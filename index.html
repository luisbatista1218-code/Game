<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas - Firebase Realtime</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .section { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        h2 { color: #444; margin-bottom: 15px; border-bottom: 2px solid #4285f4; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; }
        button:hover { background: #3367d6; }
        .lista { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
        .item { padding: 8px; border-bottom: 1px solid #eee; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; text-align: center; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid #4285f4; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #333; }
        .stat-label { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè™ Sistema Simples de Vendas (Realtime Database)</h1>
        
        <div class="sections">
            <!-- CADASTRO -->
            <div class="section">
                <h2>‚ûï Cadastrar Produto</h2>
                <div class="form-group">
                    <input type="text" id="codigo" placeholder="C√≥digo (ex: CAM001)">
                </div>
                <div class="form-group">
                    <input type="text" id="nome" placeholder="Nome (ex: Camiseta Azul)">
                </div>
                <div class="form-group">
                    <input type="number" id="preco" placeholder="Pre√ßo R$ (ex: 29.90)" step="0.01">
                </div>
                <div class="form-group">
                    <input type="number" id="estoque" placeholder="Estoque (ex: 100)" min="0">
                </div>
                <button onclick="cadastrarProduto()">Salvar Produto</button>
                <div id="status-cadastro" class="status"></div>
                
                <h3>üìã Produtos:</h3>
                <div class="lista" id="lista-produtos">
                    <div>Carregando...</div>
                </div>
            </div>
            
            <!-- VENDAS -->
            <div class="section">
                <h2>üí∞ Registrar Venda</h2>
                <div class="form-group">
                    <select id="produtoSelect">
                        <option>Carregando produtos...</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="quantidade" placeholder="Quantidade" value="1" min="1">
                </div>
                <div class="form-group">
                    <input type="text" id="cliente" placeholder="Nome do cliente">
                </div>
                <button onclick="registrarVenda()">Registrar Venda</button>
                <div id="status-venda" class="status"></div>
                
                <h3>üõí √öltimas Vendas:</h3>
                <div class="lista" id="lista-vendas">
                    <div>Carregando...</div>
                </div>
            </div>
            
            <!-- DASHBOARD -->
            <div class="section">
                <h2>üìä Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-produtos">0</div>
                        <div class="stat-label">Produtos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-vendas">0</div>
                        <div class="stat-label">Vendas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="faturamento">R$ 0</div>
                        <div class="stat-label">Faturamento</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="vendas-hoje">0</div>
                        <div class="stat-label">Vendas Hoje</div>
                    </div>
                </div>
                
                <h3>üìà Produtos Mais Vendidos:</h3>
                <div class="lista" id="top-produtos">
                    <div>Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script>
        // SUAS CONFIGURA√á√ïES
        const firebaseConfig = {
            apiKey: "AIzaSyDhxzoRmrYhuIwKkFtlF_H36NklLwVXSN0",
            authDomain: "deliveryapp-a6c48.firebaseapp.com",
            databaseURL: "https://deliveryapp-a6c48-default-rtdb.firebaseio.com",
            projectId: "deliveryapp-a6c48",
            storageBucket: "deliveryapp-a6c48.firebasestorage.app",
            messagingSenderId: "547092721941",
            appId: "1:547092721941:web:b0feaefe7d6265c32bf91c"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Refer√™ncias aos n√≥s do banco
        const produtosRef = database.ref('produtos');
        const vendasRef = database.ref('vendas');

        // FUN√á√ÉO: Cadastrar Produto
        window.cadastrarProduto = function() {
            const codigo = document.getElementById('codigo').value.trim();
            const nome = document.getElementById('nome').value.trim();
            const preco = parseFloat(document.getElementById('preco').value);
            const estoque = parseInt(document.getElementById('estoque').value);
            
            if (!codigo || !nome || !preco || !estoque) {
                showStatus('status-cadastro', 'Preencha todos os campos!', 'error');
                return;
            }
            
            // Cria um ID √∫nico
            const produtoId = Date.now().toString();
            
            // Salva no Realtime Database
            produtosRef.child(produtoId).set({
                id: produtoId,
                codigo: codigo,
                nome: nome,
                preco: preco,
                estoque: estoque,
                estoqueAtual: estoque,
                vendas: 0,
                dataCadastro: new Date().toISOString()
            })
            .then(() => {
                showStatus('status-cadastro', '‚úÖ Produto cadastrado!', 'success');
                // Limpar campos
                document.getElementById('codigo').value = '';
                document.getElementById('nome').value = '';
                document.getElementById('preco').value = '';
                document.getElementById('estoque').value = '';
            })
            .catch((error) => {
                showStatus('status-cadastro', '‚ùå Erro: ' + error.message, 'error');
            });
        };

        // FUN√á√ÉO: Registrar Venda
        window.registrarVenda = function() {
            const produtoSelect = document.getElementById('produtoSelect');
            const produtoId = produtoSelect.value;
            const quantidade = parseInt(document.getElementById('quantidade').value);
            const cliente = document.getElementById('cliente').value.trim();
            
            if (!produtoId || !cliente || !quantidade) {
                showStatus('status-venda', 'Preencha todos os campos!', 'error');
                return;
            }
            
            // Busca dados do produto
            produtosRef.child(produtoId).once('value')
            .then((snapshot) => {
                const produto = snapshot.val();
                if (!produto) {
                    showStatus('status-venda', 'Produto n√£o encontrado!', 'error');
                    return;
                }
                
                if (quantidade > produto.estoqueAtual) {
                    showStatus('status-venda', `Estoque insuficiente! Dispon√≠vel: ${produto.estoqueAtual}`, 'error');
                    return;
                }
                
                // Cria ID √∫nico para venda
                const vendaId = Date.now().toString();
                const valorTotal = produto.preco * quantidade;
                
                // Registra a venda
                vendasRef.child(vendaId).set({
                    id: vendaId,
                    produtoId: produtoId,
                    produtoCodigo: produto.codigo,
                    produtoNome: produto.nome,
                    quantidade: quantidade,
                    valorUnitario: produto.preco,
                    valorTotal: valorTotal,
                    cliente: cliente,
                    dataVenda: new Date().toISOString(),
                    timestamp: Date.now()
                })
                .then(() => {
                    // Atualiza estoque do produto
                    const novoEstoque = produto.estoqueAtual - quantidade;
                    const totalVendas = (produto.vendas || 0) + quantidade;
                    
                    return produtosRef.child(produtoId).update({
                        estoqueAtual: novoEstoque,
                        vendas: totalVendas
                    });
                })
                .then(() => {
                    showStatus('status-venda', '‚úÖ Venda registrada!', 'success');
                    document.getElementById('cliente').value = '';
                    document.getElementById('quantidade').value = '1';
                })
                .catch((error) => {
                    showStatus('status-venda', '‚ùå Erro: ' + error.message, 'error');
                });
            });
        };

        // FUN√á√ÉO: Mostrar status
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            setTimeout(() => element.textContent = '', 3000);
        }

        // FUN√á√ÉO: Formatar moeda
        function formatCurrency(value) {
            return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',');
        }

        // ========== ESCUTAR DADOS EM TEMPO REAL ==========
        
        // Escutar produtos
        produtosRef.on('value', (snapshot) => {
            const produtos = snapshot.val() || {};
            const lista = document.getElementById('lista-produtos');
            const select = document.getElementById('produtoSelect');
            
            lista.innerHTML = '';
            select.innerHTML = '<option value="">Selecione um produto</option>';
            
            let totalProdutos = 0;
            Object.entries(produtos).forEach(([id, produto]) => {
                totalProdutos++;
                
                // Adicionar √† lista
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <strong>${produto.codigo}</strong>: ${produto.nome} 
                    - ${formatCurrency(produto.preco)} 
                    (Estoque: ${produto.estoqueAtual})
                `;
                lista.appendChild(div);
                
                // Adicionar ao select (apenas com estoque)
                if (produto.estoqueAtual > 0) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${produto.codigo} - ${produto.nome} (${produto.estoqueAtual} dispon√≠veis)`;
                    select.appendChild(option);
                }
            });
            
            document.getElementById('total-produtos').textContent = totalProdutos;
            
            if (totalProdutos === 0) {
                lista.innerHTML = '<div>Nenhum produto cadastrado</div>';
            }
        });

        // Escutar vendas e calcular dashboard
        vendasRef.on('value', (snapshot) => {
            const vendas = snapshot.val() || {};
            const lista = document.getElementById('lista-vendas');
            const hoje = new Date().toDateString();
            
            lista.innerHTML = '';
            
            let totalVendas = 0;
            let faturamento = 0;
            let vendasHoje = 0;
            const produtosVendidos = {};
            
            // Ordenar por data (mais recentes primeiro)
            const vendasArray = Object.values(vendas);
            vendasArray.sort((a, b) => b.timestamp - a.timestamp);
            
            // Processar vendas
            vendasArray.forEach((venda, index) => {
                totalVendas++;
                faturamento += venda.valorTotal || 0;
                
                // Verificar se √© hoje
                const dataVenda = new Date(venda.dataVenda).toDateString();
                if (dataVenda === hoje) {
                    vendasHoje += venda.quantidade || 1;
                }
                
                // Contar por produto
                if (venda.produtoCodigo) {
                    produtosVendidos[venda.produtoCodigo] = 
                        (produtosVendidos[venda.produtoCodigo] || 0) + (venda.quantidade || 1);
                }
                
                // Mostrar apenas 5 √∫ltimas
                if (index < 5) {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div>
                            <strong>${venda.produtoNome}</strong><br>
                            <small>${venda.cliente} - ${new Date(venda.dataVenda).toLocaleDateString()}</small>
                        </div>
                        <div style="text-align: right;">
                            ${venda.quantidade}x<br>
                            <strong>${formatCurrency(venda.valorTotal)}</strong>
                        </div>
                    `;
                    lista.appendChild(div);
                }
            });
            
            // Atualizar dashboard
            document.getElementById('total-vendas').textContent = totalVendas;
            document.getElementById('faturamento').textContent = formatCurrency(faturamento);
            document.getElementById('vendas-hoje').textContent = vendasHoje;
            
            // Top produtos vendidos
            const topDiv = document.getElementById('top-produtos');
            topDiv.innerHTML = '';
            
            const topArray = Object.entries(produtosVendidos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            topArray.forEach(([codigo, quantidade], index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    ${index + 1}¬∫ - ${codigo}: <strong>${quantidade} vendas</strong>
                `;
                topDiv.appendChild(div);
            });
            
            if (totalVendas === 0) {
                lista.innerHTML = '<div>Nenhuma venda registrada</div>';
                topDiv.innerHTML = '<div>Nenhuma venda registrada</div>';
            }
        });

        // Mostrar que est√° conectado
        setTimeout(() => {
            showStatus('status-cadastro', '‚úÖ Conectado ao Firebase!', 'success');
        }, 1000);
    </script>
</body>
</html>
